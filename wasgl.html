<!DOCTYPE html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Shape wgl wasm</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
      body {
        background-color: black;
      }
      #c {
        border: 2px solid black;
        width: 40em;
        height: 30em;
      }
      #fps {
        width: 20em;
      }
      #whatFile {
        width: 2em;
      }
      #main {
        display: block;
        margin: auto;
        text-align: center;
        color: LimeGreen;
      }
    </style>
  </head>
  <body>



<div id="main">
<canvas id="c" width="400" height="400" ></canvas>
<span id="fps"></span>
</div>

<script id="vs" type="x-shader/x-vertex">#version 300 es

  in vec4 a_position;
  in vec3 a_normal;
  out vec3 v_normal;
  out vec3 v_surfacetolite;
  uniform mat4 u_worldviewprojection;
  uniform mat4 u_worldinvtrans;
  uniform mat4 u_world;
  uniform vec3 u_liteworldpos;

  void main() {
    gl_Position = u_worldviewprojection * a_position;

    v_normal = mat3(u_worldinvtrans) * a_normal;

    vec3 surfaceworldpos = (u_world * a_position).xyz;

    v_surfacetolite = u_liteworldpos - surfaceworldpos;
    v_surfacetolite = normalize(v_surfacetolite);
  }

</script>
<script id="fs" type="x-shader/x-fragment">#version 300 es

  precision mediump float;
  in vec3 v_normal;
  in vec3 v_surfacetolite;
  out vec4 outColor;
  uniform vec3 u_litdirection;

  void main() { 

    vec4 base_color = vec4(0.5,0.8,0.8,1);
    float light = dot(v_normal,v_surfacetolite);
    outColor = base_color * light;
  }

</script>

<script src="index.js"></script>
<script>



function process(mesh,model){
  var textp  = allocate(intArrayFromString(mesh), 'i8', ALLOC_NORMAL);//or 0
  
  var fArray = new Float32Array(50000);
  var nArray = new Float32Array(50000);

  var fArrayp = Module._malloc(fArray.length * fArray.BYTES_PER_ELEMENT);
  var nArrayp = Module._malloc(fArray.length * fArray.BYTES_PER_ELEMENT);

  //this is for sending floats to wasm, don't need it
  //Module.HEAPF32.set(fArray,fArrayp>>2);
  //Module.HEAPF32.set(nArray,nArrayp>>2);

  var fArraylen = _parse(textp,fArrayp,fArray.length,nArrayp);

  var fArrayIndex = fArrayp/Float32Array.BYTES_PER_ELEMENT;
  var nArrayIndex = nArrayp/Float32Array.BYTES_PER_ELEMENT;

  fArray = Module.HEAPF32.slice(fArrayIndex,fArrayIndex+fArraylen);
  nArray = Module.HEAPF32.slice(nArrayIndex,nArrayIndex+fArraylen);

  _free(textp);

  model.verts = fArray;
  model.norms = nArray;
}

function getcenter(){
  var center = new Float32Array(3);
  var centerp = Module._malloc(3 * 32);
  _getcenter(centerp);
  cindex = centerp/Float32Array.BYTES_PER_ELEMENT;
  center = Module.HEAPF32.slice(cindex,cindex+3);
  //console.log(JSON.stringify(center));
  return center;
}





</script>
<script src="math.js"></script>
<script src="mainwasm.js"></script>

  </body>
</html> 
